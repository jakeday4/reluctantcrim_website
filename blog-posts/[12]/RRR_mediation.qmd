---
title: "RRR: Mediation Makes My Head Hurt!"
author: "Jon Brauer"
date: "2024-05-13"
image: thinking_hurts.jpeg
image-alt: "Mediation makes my head hurt"
description: "Our first Reluctantly Rapid Response (RRR) post addresses a confusing mediation issue."
citation:
  url: https://reluctantcriminologists.com/blog-posts/[4]/causation-no-corr.html
categories: [general, rstats, causality, mediation]
# https://community.rstudio.com/t/quarto-how-to-cross-reference-unnumbered-book-chapter/136279/2
format:
  html:
    code-fold: true
    code-summary: "Show code"
execute: 
  warning: false
draft: false
---

![Mediation makes my head hurt](thinking_hurts.jpeg)

## Motivation

At times, we find ourselves wanting to publish a brief or "quick hitting" entry with a brief comment or coding example but do not have the time for a formal blog post. So, we decided to pilot a new type of entry. For lack of a better term, we'll call this a "Reluctantly Rapid Response" (RRR for short). We are generally reluctant to post anything and doubly reluctant to post anything rapidly, so the name seems fitting to us. 

This RRR entry provides code and output from a simple simulation motivated by [Brier Gallihugh's](https://twitter.com/Brier_Gallihugh) [question on X](https://x.com/Brier_Gallihugh/status/1789398630425649302) about a mediation issue. 

![A mediation mystery unfolds](BG_tweet.jpeg)

The following simulation, plots, and analysis provide one example situation in which changes in a mediator (ChgM) are positively correlated with changes in an outcome (ChgY) within two groups A & B, yet Group A membership is estimated as having a negative indirect effect on changes in the outcome (ChgY) via changes in the mediator (ChgM). In this example, the total negative indirect effect is generated by a small negative "pure" indirect (PNIE) effect combined with a small "mediated interaction" (INTmed) effect. 

I am not claiming that this is what is happening in the original poster's (BG's) data. In fact, one apparent and important difference is that BG stated in a later tweet that "Group A shows higher rates of their mediator compared to Group B AND lower rates of the outcome compared to Group B as well." 

![The probability plot thickens](BG_tweet2.jpeg)

If "rates" refer to initial status at Time 1 (not changes), then perhaps we could generate comparable data. Yet, if "rates" refers to the change scores themselves, then it seems we may still have an unsolved problem on our hands. In the simulation below, changes in the mediator are positively correlated with changes in the outcome in both Groups A and B, and Group A has lower outcome change scores on average; however, specification of marginally lower mediator change scores on average for Group A contribute to the negative indirect effect estimates. 

Please feel free to reach out on X or via email if you see errors or have other suggestions! 

## Load libraries

```{r}
library(tidyverse)
library(ggplot2)
library(patchwork)
library(psych)
# library(devtools)
# install_github("jtextor/dagitty/r")
library(dagitty)
library(CMAverse)

```

## Basic DAG

```{r}
SimpsonDAG <- dagitty("dag{
  GroupA -> ChgM -> ChgY
  GroupA -> ChgY
   }") 
coordinates(SimpsonDAG) <- list(
  x=c(GroupA=1, ChgM=2, ChgY=3),
  y=c(GroupA=2, ChgM=1, ChgY=2) )

plot(SimpsonDAG)
```

## Simulate data

```{r}

set.seed(1138)
n <- 500
GroupA<-rbinom(n=1000,size=1,prob=0.50)
ChgM <- -.1*GroupA + rnorm(n)
ChgY <- .5*ChgM + -.5*GroupA + .4*GroupA*ChgM + rnorm(n)
simdata <- tibble(GroupA, ChgM, ChgY)

simdata
```

```{r}
GroupAplot <- simdata %>% ggplot() +
  geom_bar(aes(x=GroupA),
                 color="#1fa187", fill="#4ac16d", alpha=.7,
                 position="identity") + 
  theme_minimal() + 
  theme(axis.text.y=element_blank(),  
        axis.ticks.y=element_blank()
        ) +
  labs(x="GroupA", y=NULL)

ChgMplot <- simdata %>% ggplot() +
  geom_histogram(aes(x=ChgM, y=..density..),
                 color="#1fa187", fill="#4ac16d", alpha=.7,
                 position="identity", 
                 breaks = seq(-4, 4, by = 1)) + 
  theme_minimal() + 
  theme(axis.text.y=element_blank(),  
        axis.ticks.y=element_blank()
        ) +
  labs(x="ChgM", y=NULL)

ChgYplot <- simdata %>% ggplot() +
  geom_histogram(aes(x=ChgY, y=..density..),
                 color="#1fa187", fill="#4ac16d", alpha=.7,
                 position="identity") + 
  theme_minimal() + 
  theme(axis.text.y=element_blank(),  
        axis.ticks.y=element_blank()
        ) +
  labs(x="ChgY", y=NULL)


GroupAplot + ChgMplot + ChgYplot
```

## Bivariate corrs

### Full sample

Positive correlation between ChgM and ChgY in full sample.

```{r}
pairs.panels(simdata,
             smooth = FALSE,      # If TRUE, draws loess smooths
             scale = FALSE,      # If TRUE, scales the correlation text font
             density = TRUE,     # If TRUE, adds density plots and histograms
             ellipses = FALSE,    # If TRUE, draws ellipses
             method = "pearson", # Correlation method (also "spearman" or "kendall")
             pch = 21,           # pch symbol
             lm = TRUE,         # If TRUE, plots linear fit rather than the LOESS (smoothed) fit
             cor = TRUE,         # If TRUE, reports correlations
             jiggle = FALSE,     # If TRUE, data points are jittered
             factor = 2,         # Jittering factor
             hist.col = 3,       # Histograms color
             stars = TRUE,       # If TRUE, adds significance level with stars
             ci = TRUE)          # If TRUE, adds confidence intervals
```

### Group A only 

Positive correlation between ChgM and ChgY within Group A.

```{r}

simdataA <- simdata %>% filter(GroupA==1) %>% select(-GroupA)
pairs.panels(simdataA, density = TRUE, method = "pearson", pch = 21, 
             lm = TRUE, cor = TRUE, hist.col = 3, stars = TRUE, ci = TRUE)  
```

### Group B only 

Positive correlation between ChgM and ChgY within Group B.

```{r}

simdataB <- simdata %>% filter(GroupA==0) %>% select(-GroupA)
pairs.panels(simdataB, density = TRUE, method = "pearson", pch = 21, 
             lm = TRUE, cor = TRUE, hist.col = 3, stars = TRUE, ci = TRUE)  
```

## Scatterplot by group

Notice inconsistent or heterogeneous effect of ChgM on ChgY across Groups. 

```{r}
ggplot(data = simdata, aes(x = ChgM, y = ChgY)) +
        geom_point(aes(shape = factor(GroupA))) +
        geom_point(aes(color = factor(GroupA))) +
        geom_smooth(method = "lm", 
                    se = FALSE, 
                    aes(color = factor(GroupA))) 
```


## Simple mediation model

Negative indirect effect of GroupA on ChgY via ChgM.

```{r}
mediate(ChgY ~ GroupA + (ChgM), data = simdata, n.iter = 10000) %>% print(short = TRUE)
```

## Mediation model accounting for exposure-mediator interaction

Total negative indirect effect (PNIE + INTmed) estimate is larger after accounting for exposure-mediator interaction. 

```{r}
set.seed(1138)
est <- cmest(data = simdata, model = "rb", outcome = "ChgY", exposure = "GroupA",
                mediator = "ChgM", EMint = TRUE,
                mreg = list("linear"), yreg = "linear",
                astar = 0, a = 1, mval = list(0),
                estimation = "imputation", inference = "bootstrap", nboot = 20)
summary(est)
```


